// prisma/schema.prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProfessorTitle {
  PRACTITIONER
  ASSISTANT
  SENIOR_ASSISTANT
  ASSISTANT_PROFESSOR
  ASSOCIATE_PROFESSOR
  FULL_PROFESSOR
  PROFESSOR_EMERITUS
}

enum Engagement {
  EMPLOYED
  EXTERNAL
}

enum WeekType {
  ALL
  A
  B
}

model Professor {
  id         String          @id @default(cuid())
  name       String
  email      String?         @unique
  phone      String?
  title      ProfessorTitle?
  engagement Engagement?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  courses         Course[]
  scheduleEntries ScheduleEntry[]
  prnRows         PRNRow[] // ⬅️ back-relation za PRNRow
}

model Subject {
  id        String   @id @default(cuid())
  code      String?  @unique // code je opcionalan
  name      String
  ects      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courses         Course[]
  subjectPrograms SubjectOnProgramYear[] // ⬅️ join sa programima
  prnRows         PRNRow[] // ⬅️ back-relation za PRNRow
}

model Room {
  id        String   @id @default(cuid())
  name      String   @unique
  shortCode String?  @unique
  capacity  Int?
  isOnline  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scheduleEntries ScheduleEntry[]
}

model Cycle {
  id        String   @id @default(cuid())
  name      String
  dateStart DateTime
  dateEnd   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  terms Term[]
}

model Term {
  id        String    @id @default(cuid())
  cycle     Cycle     @relation(fields: [cycleId], references: [id])
  cycleId   String
  name      String
  dateStart DateTime?
  dateEnd   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  courses         Course[]
  scheduleEntries ScheduleEntry[]
}

model StudyProgram {
  id        String   @id @default(cuid())
  name      String
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  years           ProgramYear[]
  subjectPrograms SubjectOnProgramYear[] // ⬅️ join
  prnPlans        PRNPlan[] // ⬅️ back-relation za PRNPlan
}

model ProgramYear {
  id         String       @id @default(cuid())
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

// Predmet ↔ StudyProgram uz godinu
model SubjectOnProgramYear {
  id         String       @id @default(cuid())
  subject    Subject      @relation(fields: [subjectId], references: [id])
  subjectId  String
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int

  @@unique([subjectId, programId], name: "uniq_subject_program")
}

model Course {
  id          String    @id @default(cuid())
  subject     Subject   @relation(fields: [subjectId], references: [id])
  subjectId   String
  professor   Professor @relation(fields: [professorId], references: [id])
  professorId String
  term        Term      @relation(fields: [termId], references: [id])
  termId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  scheduleEntries ScheduleEntry[]
}

model ScheduleEntry {
  id          String    @id @default(cuid())
  term        Term      @relation(fields: [termId], references: [id])
  termId      String
  course      Course    @relation(fields: [courseId], references: [id])
  courseId    String
  professor   Professor @relation(fields: [professorId], references: [id])
  professorId String
  room        Room      @relation(fields: [roomId], references: [id])
  roomId      String

  groupName String?
  dayOfWeek Int
  startMin  Int
  endMin    Int
  weekType  WeekType?
  isOnline  Boolean?
  note      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ================= PRN =================

model PRNPlan {
  id         String       @id @default(cuid())
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int // 1..4
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  rows PRNRow[]

  @@unique([programId, yearNumber], name: "uniq_plan_per_program_year")
}

model PRNRow {
  id     String  @id @default(cuid())
  plan   PRNPlan @relation(fields: [planId], references: [id])
  planId String

  subject   Subject @relation(fields: [subjectId], references: [id])
  subjectId String

  professor   Professor? @relation(fields: [professorId], references: [id])
  professorId String?

  // semestralna pokrivenost (sati)
  lectureHours  Int? // Predavanja
  exerciseHours Int? // Vježbe

  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
