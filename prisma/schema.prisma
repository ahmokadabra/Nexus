// prisma/schema.prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProfessorTitle {
  PRACTITIONER
  ASSISTANT
  SENIOR_ASSISTANT
  ASSISTANT_PROFESSOR
  ASSOCIATE_PROFESSOR
  FULL_PROFESSOR
  PROFESSOR_EMERITUS
}

enum Engagement {
  EMPLOYED
  EXTERNAL
}

enum WeekType {
  ALL
  A
  B
}

model Professor {
  id         String          @id @default(cuid())
  name       String
  email      String?         @unique
  phone      String?
  title      ProfessorTitle?
  engagement Engagement?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  courses         Course[]
  scheduleEntries ScheduleEntry[]
  prnrows         PRNRow[]
}

model Subject {
  id        String   @id @default(cuid())
  code      String?  @unique // <-- više nije obavezno
  name      String
  ects      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courses         Course[]
  subjectPrograms SubjectProgram[] // <-- join prema StudyProgram
  prnrows         PRNRow[]
}

model Room {
  id        String   @id @default(cuid())
  name      String   @unique
  shortCode String?  @unique
  capacity  Int?
  isOnline  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scheduleEntries ScheduleEntry[]
}

model Cycle {
  id        String   @id @default(cuid())
  name      String
  dateStart DateTime
  dateEnd   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  terms Term[]
}

model Term {
  id        String    @id @default(cuid())
  cycle     Cycle     @relation(fields: [cycleId], references: [id])
  cycleId   String
  name      String
  dateStart DateTime?
  dateEnd   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  courses         Course[]
  scheduleEntries ScheduleEntry[]
}

model StudyProgram {
  id        String   @id @default(cuid())
  name      String
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  years           ProgramYear[]
  subjectPrograms SubjectProgram[] // <-- join prema Subject
  prnplans        PRNPlan[]
}

model ProgramYear {
  id         String       @id @default(cuid())
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

model Course {
  id          String    @id @default(cuid())
  subject     Subject   @relation(fields: [subjectId], references: [id])
  subjectId   String
  professor   Professor @relation(fields: [professorId], references: [id])
  professorId String
  term        Term      @relation(fields: [termId], references: [id])
  termId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  scheduleEntries ScheduleEntry[]
}

model ScheduleEntry {
  id          String    @id @default(cuid())
  term        Term      @relation(fields: [termId], references: [id])
  termId      String
  course      Course    @relation(fields: [courseId], references: [id])
  courseId    String
  professor   Professor @relation(fields: [professorId], references: [id])
  professorId String
  room        Room      @relation(fields: [roomId], references: [id])
  roomId      String

  groupName String?
  dayOfWeek Int
  startMin  Int
  endMin    Int
  weekType  WeekType?
  isOnline  Boolean?
  note      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NEW: Join tabela Subject <-> StudyProgram, sa yearNumber
model SubjectProgram {
  subjectId  String
  programId  String
  yearNumber Int

  subject Subject      @relation(fields: [subjectId], references: [id])
  program StudyProgram @relation(fields: [programId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([subjectId, programId]) // po subjektu i programu jedinstveno, yearNumber se može mijenjati
}

/// --- PRN: Plan realizacije nastave ---

model PRNPlan {
  id         String       @id @default(cuid())
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  rows PRNRow[]

  @@unique([programId, yearNumber]) // jedan plan po programu i godini
}

model PRNRow {
  id     String  @id @default(cuid())
  plan   PRNPlan @relation(fields: [planId], references: [id])
  planId String

  subject   Subject @relation(fields: [subjectId], references: [id])
  subjectId String

  // opcionalno: odgovorni profesor za predmet (jednostavna 1:1 varijanta)
  professor   Professor? @relation(fields: [professorId], references: [id])
  professorId String?

  // ukupna pokrivenost u semestru (brojevi unosiš ti)
  lectureTotal  Int? @default(0)
  exerciseTotal Int? @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, subjectId]) // po predmetu jednom unutar plana
}
