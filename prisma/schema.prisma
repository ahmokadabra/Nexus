// prisma/schema.prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // koristi direktnu konekciju za migrate/generate
}

enum ProfessorTitle {
  PRACTITIONER
  ASSISTANT
  SENIOR_ASSISTANT
  ASSISTANT_PROFESSOR
  ASSOCIATE_PROFESSOR
  FULL_PROFESSOR
  PROFESSOR_EMERITUS
}

enum Engagement {
  EMPLOYED
  EXTERNAL
}

enum WeekType {
  ALL
  A
  B
}

enum UserRole {
  ADMIN
  USER
}

// ⬇️ NOVO: semestar predmeta
enum Semester {
  ZIMSKI
  LJETNI
}

model Professor {
  id         String          @id @default(cuid())
  name       String
  email      String?         @unique
  phone      String?
  title      ProfessorTitle?
  engagement Engagement?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  courses         Course[]
  scheduleEntries ScheduleEntry[]
  prnRows         PRNRow[] // back-relation za PRNRow
}

model Subject {
  id         String   @id @default(cuid())
  code       String?  @unique // code je opcionalan
  name       String
  ects       Int?
  isElective Boolean  @default(false) // false = obavezni, true = izborni
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  courses         Course[]
  subjectPrograms SubjectOnProgramYear[] // join sa programima (po godini + semestru)
  prnRows         PRNRow[]               // back-relation za PRNRow
}

model Room {
  id        String   @id @default(cuid())
  name      String   @unique
  shortCode String?  @unique
  capacity  Int?
  isOnline  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scheduleEntries ScheduleEntry[]
}

model Cycle {
  id        String   @id @default(cuid())
  name      String
  dateStart DateTime
  dateEnd   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  terms Term[]
}

model Term {
  id        String    @id @default(cuid())
  cycle     Cycle     @relation(fields: [cycleId], references: [id])
  cycleId   String
  name      String
  dateStart DateTime?
  dateEnd   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  courses         Course[]
  scheduleEntries ScheduleEntry[]
}

model StudyProgram {
  id        String   @id @default(cuid())
  name      String
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  years           ProgramYear[]
  subjectPrograms SubjectOnProgramYear[] // join
  prnPlans        PRNPlan[]              // back-relation za PRNPlan
}

model ProgramYear {
  id         String       @id @default(cuid())
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

// Predmet ↔ StudyProgram uz godinu i semestar
model SubjectOnProgramYear {
  id         String       @id @default(cuid())
  subject    Subject      @relation(fields: [subjectId], references: [id])
  subjectId  String
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int
  semester   Semester     @default(ZIMSKI) // ⬅️ NOVO

  // ⬇️ NOVO: jedinstveno po predmetu + programu + godini + semestru
  @@unique([subjectId, programId, yearNumber, semester], name: "uniq_subject_program_year_sem")

  // ⬇️ Opcionalno ubrzanje upita po programu/godini/sem
  @@index([programId, yearNumber, semester], name: "idx_prog_year_sem")
}

model Course {
  id          String    @id @default(cuid())
  subject     Subject   @relation(fields: [subjectId], references: [id])
  subjectId   String
  professor   Professor @relation(fields: [professorId], references: [id])
  professorId String
  term        Term      @relation(fields: [termId], references: [id])
  termId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  scheduleEntries ScheduleEntry[]
}

model ScheduleEntry {
  id          String    @id @default(cuid())
  term        Term      @relation(fields: [termId], references: [id])
  termId      String
  course      Course    @relation(fields: [courseId], references: [id])
  courseId    String
  professor   Professor @relation(fields: [professorId], references: [id])
  professorId String
  room        Room      @relation(fields: [roomId], references: [id])
  roomId      String

  groupName String?
  dayOfWeek Int
  startMin  Int
  endMin    Int
  weekType  WeekType?
  isOnline  Boolean?
  note      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  role         UserRole @default(USER)

  canDB          Boolean @default(true)
  canPlan        Boolean @default(true)
  canTeacherLoad Boolean @default(true)
  canSchedule    Boolean @default(true)
  canLibrary     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ================= PRN =================

model PRNPlan {
  id         String       @id @default(cuid())
  program    StudyProgram @relation(fields: [programId], references: [id])
  programId  String
  yearNumber Int          // 1..4
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  rows PRNRow[]

  @@unique([programId, yearNumber], name: "uniq_plan_per_program_year")
}

model PRNRow {
  id     String  @id @default(cuid())
  plan   PRNPlan @relation(fields: [planId], references: [id])
  planId String

  subject   Subject @relation(fields: [subjectId], references: [id])
  subjectId String

  professor   Professor? @relation(fields: [professorId], references: [id])
  professorId String?

  // semestralna pokrivenost (sati)
  lectureHours  Int? // Predavanja
  exerciseHours Int? // Vježbe

  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
